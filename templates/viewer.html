<!DOCTYPE html>
<html>
<head>
    <title>Viewer - {{ folder_name }}</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #image-container { text-align: center; }
        #image-container img { max-width: 100%; height: auto; }
        #metadata { margin-top: 20px; }
        #navigation { margin-top: 20px; text-align: center; }
        button, input[type="range"] { margin: 5px; }
        #folder-link { margin-bottom: 20px; display: block; }
        #slider-container { text-align: center; margin-top: 20px; }
        table { margin: 0 auto; border-collapse: collapse; }
        td, th { padding: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <a id="folder-link" href="/">&#8592; Back to Folders</a>
    <h1>Viewing Folder: {{ folder_name }}</h1>
    <div id="image-container">
        <img id="frame-image" src="" alt="Frame Image">
    </div>
    <div id="metadata">
        <p>Frame: <span id="frame-number"></span> / <span id="total-frames"></span></p>
        <p>Input (Metadata): <span id="input-data"></span></p>
        <p>Input (Cache): <span id="input-data-cache"></span></p>
        <p>Model Prediction: <span id="model-prediction"></span></p>
        <p>Reward (Metadata): <span id="reward-data"></span></p>
        <p>Punishment (Metadata): <span id="punishment-data"></span></p>
        <p>Net Reward (Cache): <span id="net-reward-cache"></span></p>
        <p>Next Reward: <span id="next-reward-data"></span></p>
        <p>Next Punishment: <span id="next-punishment-data"></span></p>
        <p>Winner: <span id="winner-status"></span></p>
    </div>
    
    <div id="slider-container">
        <input type="range" id="frame-slider" min="0" max="0" value="0" style="width: 80%;">
    </div>
    <div id="navigation">
        <button id="prev-button">Previous Frame</button>
        <button id="next-button">Next Frame</button>
        <button id="inference-button">Run Inference</button> <!-- Button to trigger inference -->
    </div>
    <script>
        var folderName = "{{ folder_name }}";
        var currentFrame = 0;
        var totalFrames = 0;
    
        function updateSliderMax(maxValue) {
            const slider = document.getElementById('frame-slider');
            slider.max = maxValue - 1;
            slider.disabled = false;  // Enable the slider once the max value is set
        }
    
        function loadFrame(frameIndex) {
            fetch(`/folder/${folderName}/frame/${frameIndex}`)
                .then(response => response.json())
                .then(data => {
                    currentFrame = data.current_frame;
                    totalFrames = data.total_frames;
    
                    // Update frame data
                    document.getElementById('frame-number').textContent = currentFrame + 1;
                    document.getElementById('total-frames').textContent = totalFrames;
                    document.getElementById('input-data').textContent = data.input;
                    document.getElementById('reward-data').textContent = data.reward !== null ? data.reward : 'None';
                    document.getElementById('punishment-data').textContent = data.punishment !== null ? data.punishment : 'None';
    
                    // Update cache data
                    document.getElementById('net-reward-cache').textContent = data.pt_net_reward !== null ? data.pt_net_reward : 'None';
                    document.getElementById('input-data-cache').textContent = data.pt_input_tensor !== null ? data.pt_input_tensor.join('') : 'None';
    
                    // Update next reward data
                    if (data.next_reward) {
                        document.getElementById('next-reward-data').textContent =
                            'Reward ' + data.next_reward.value + ', ' + data.next_reward.frames_ahead + ' frames ahead';
                    } else {
                        document.getElementById('next-reward-data').textContent = 'None';
                    }
    
                    // Update next punishment data
                    if (data.next_punishment) {
                        document.getElementById('next-punishment-data').textContent =
                            'Punishment ' + data.next_punishment.value + ', ' + data.next_punishment.frames_ahead + ' frames ahead';
                    } else {
                        document.getElementById('next-punishment-data').textContent = 'None';
                    }
    
                    // Update winner status
                    const winnerText = data.winner === true ? "Yes" : data.winner === false ? "No" : "Undetermined";
                    document.getElementById('winner-status').textContent = winnerText;
    
                    // Update image and slider
                    document.getElementById('frame-image').src = '/' + data.image_path;
                    document.getElementById('frame-slider').value = currentFrame;

                    // Clear model prediction until inference is run
                    document.getElementById('model-prediction').textContent = 'None';
                    
                    // Set the slider max value if it's the first load
                    if (totalFrames > 0 && document.getElementById('frame-slider').max == "0") {
                        updateSliderMax(totalFrames);
                    }
                })
                .catch(error => {
                    console.error('Error loading frame data:', error);
                });
        }

        // Button event listeners
        document.getElementById('prev-button').addEventListener('click', function() {
            if (currentFrame > 0) {
                loadFrame(currentFrame - 1);
            }
        });
    
        document.getElementById('next-button').addEventListener('click', function() {
            if (currentFrame < totalFrames - 1) {
                loadFrame(currentFrame + 1);
            }
        });

        // Inference button event listener
        document.getElementById('inference-button').addEventListener('click', function() {
            runInference(currentFrame);
        });
    
        // Slider change event
        document.getElementById('frame-slider').addEventListener('input', function() {
            loadFrame(parseInt(this.value));
        });
    
        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowLeft') {
                if (currentFrame > 0) {
                    loadFrame(currentFrame - 1);
                }
            } else if (event.key === 'ArrowRight') {
                if (currentFrame < totalFrames - 1) {
                    loadFrame(currentFrame + 1);
                }
            }
        });

        // Function to run inference when button is clicked
        function runInference(frameIndex) {
            fetch(`/folder/${folderName}/frame/${frameIndex}/inference`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('model-prediction').textContent = data.model_prediction || 'None';
                })
                .catch(error => {
                    console.error('Error running inference:', error);
                });
        }
    
        // Initial load
        loadFrame(0);
    </script>
    
</body>
</html>
